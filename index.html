<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Juego: Ordenar Pasos de LogÃ­stica</title>
    <!-- Cargamos Tailwind CSS para un diseÃ±o limpio -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Biblioteca para el efecto de confeti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        /* Estilo para los elementos mientras se arrastran */
        .dragging {
            opacity: 0.5;
            transform: scale(0.95);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        
        /* Estilo para las zonas de soltar cuando un elemento estÃ¡ encima */
        .drag-over {
            background-color: #dbeafe; /* bg-blue-100 */
            border-style: dashed;
            border-color: #60a5fa; /* border-blue-400 */
            transform: scale(1.01);
            transition: all 0.2s;
        }
        
        /* AnimaciÃ³n suave para los elementos al aparecer */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Estilos para la ventana modal de Ã©xito */
        #success-modal {
            display: none;
            z-index: 50;
        }
    </style>
</head>
<body class="bg-slate-100 font-sans p-6 md:p-10">

    <!-- Ventana Modal de Ã‰xito -->
    <div id="success-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl p-8 text-center max-w-md mx-auto transform transition-all" style="animation: fadeIn 0.3s ease-out;">
            <h2 class="text-4xl font-bold text-green-600 mb-4">Â¡Excelente!</h2>
            <p class="text-xl text-gray-700 mb-6">Â¡Has completado el desafÃ­o perfectamente! ðŸŽ‰</p>
            <button id="close-modal-button" class="px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition-colors focus:outline-none focus:ring-2 focus:ring-indigo-500">
                Cerrar
            </button>
        </div>
    </div>

    <div class="max-w-7xl mx-auto bg-white p-6 md:p-8 rounded-2xl shadow-xl">
        <header class="border-b border-gray-200 pb-6 mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-teal-500 to-indigo-600 mb-4">
                DesafÃ­o: LogÃ­stica de ImportaciÃ³n
            </h1>
            <p class="text-lg text-gray-600">Primero, arrastra y ordena los <b>Pasos Principales</b> a la izquierda. Luego, arrastra las <b>Sub-Tareas</b> dentro del paso que corresponda.</p>
            
            <!-- Ãrea de PuntuaciÃ³n -->
            <div id="score-area" class="text-xl font-bold text-gray-700 mt-6 text-center p-4 bg-gray-50 rounded-lg">
                <!-- La puntuaciÃ³n se insertarÃ¡ aquÃ­ -->
            </div>
        </header>

        <!-- Contenedor principal del juego -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
            
            <!-- COLUMNA IZQUIERDA: ÃREA DE CONSTRUCCIÃ“N -->
            <!-- AÃ±adimos data-drop-target para identificarlo fÃ¡cilmente -->
            <div class="md:col-span-2 min-h-[400px] bg-blue-50 border-2 border-dashed border-blue-300 rounded-xl p-6 transition-colors duration-200" id="steps-container" data-type="main-container">
                <!-- Los pasos ordenados irÃ¡n aquÃ­ -->
            </div>

            <!-- COLUMNA DERECHA: PIEZAS -->
            <div class="md:col-span-1 space-y-6">
                <!-- Caja de Pasos Desordenados -->
                <div class="bg-slate-200 p-4 rounded-lg shadow">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4 text-center">Pasos</h3>
                    <div id="jumbled-steps" class="space-y-3 min-h-[100px] transition-colors duration-200" data-type="steps-source">
                        <!-- Pasos desordenados irÃ¡n aquÃ­ -->
                    </div>
                </div>

                <!-- Caja de Tareas Desordenadas -->
                <div class="bg-slate-200 p-4 rounded-lg shadow">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4 text-center">Sub-Tareas</h3>
                    <div id="jumbled-tasks" class="space-y-3 min-h-[200px] transition-colors duration-200" data-type="tasks-source">
                        <!-- Tareas desordenadas irÃ¡n aquÃ­ -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Botones de AcciÃ³n -->
        <footer class="mt-10 pt-6 border-t border-gray-200 flex flex-col sm:flex-row justify-center items-center gap-4">
            <button id="check-button" class="w-full sm:w-auto px-8 py-3 bg-teal-600 text-white text-lg font-semibold rounded-lg shadow-md hover:bg-teal-700 transition-all focus:outline-none focus:ring-2 focus:ring-teal-500">
                Verificar
            </button>
            <button id="reset-button" class="w-full sm:w-auto px-8 py-3 bg-gray-600 text-white text-lg font-semibold rounded-lg shadow-md hover:bg-gray-700 transition-all focus:outline-none focus:ring-2 focus:ring-gray-500">
                Reiniciar
            </button>
        </footer>

        <!-- Ãrea de Mensajes -->
        <div id="message-area" class="mt-6 text-center text-xl font-medium"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- 1. DEFINICIÃ“N DE DATOS ---
            const correctSteps = {
                "step-1": {
                    title: "Paso: Contacto proveedor",
                    tasks: ["Identificar proveedor", "Negociar y generar acuerdo (Icoterms)"]
                },
                "step-2": {
                    title: "Paso: PreparaciÃ³n y envÃ­o de mercaderÃ­a",
                    tasks: ["EmisiÃ³n de orden de compra", "PreparaciÃ³n de mercaderÃ­a", "DocumentaciÃ³n de envÃ­o"]
                },
                "step-3": {
                    title: "Paso: Transporte internacional",
                    tasks: ["Transporte de mercaderÃ­a"]
                },
                "step-4": {
                    title: "Paso: Proceso Aduanero",
                    tasks: ["Arribo y notificaciÃ³n", "TrÃ¡mite aduanero (DIN)", "InspecciÃ³n aduanera"]
                },
                "step-5": {
                    title: "Paso: Transporte nacional",
                    tasks: ["LiberaciÃ³n nacional", "Transporte bodega"]
                },
                "step-6": {
                    title: "Paso: RecepciÃ³n y almacenamiento",
                    tasks: ["RecepciÃ³n de mercaderÃ­a", "Almacenamiento de mercaderÃ­a"]
                }
            };

            const allTasks = Object.values(correctSteps).flatMap(step => step.tasks);
            const allSteps = Object.keys(correctSteps).map(key => ({ id: key, title: correctSteps[key].title }));

            // --- 2. REFERENCIAS DOM ---
            const jumbledContainer = document.getElementById('jumbled-tasks');
            const jumbledStepsContainer = document.getElementById('jumbled-steps');
            const stepsContainer = document.getElementById('steps-container');
            const checkButton = document.getElementById('check-button');
            const resetButton = document.getElementById('reset-button');
            const messageArea = document.getElementById('message-area');
            const successModal = document.getElementById('success-modal');
            const closeModalButton = document.getElementById('close-modal-button');
            const scoreArea = document.getElementById('score-area');

            let draggedElement = null;

            // --- 3. INICIALIZACIÃ“N ---
            
            // Agregamos listeners a los contenedores principales
            [stepsContainer, jumbledContainer, jumbledStepsContainer].forEach(container => {
                addDragListeners(container);
            });

            function initializeGame() {
                jumbledContainer.innerHTML = '';
                jumbledStepsContainer.innerHTML = '';
                stepsContainer.innerHTML = '';
                messageArea.innerHTML = '';
                scoreArea.innerHTML = 'Presiona "Verificar" para ver tu puntuaciÃ³n.';
                successModal.style.display = 'none';

                const shuffledTasks = [...allTasks].sort(() => Math.random() - 0.5);
                shuffledTasks.forEach(task => jumbledContainer.appendChild(createTaskElement(task)));

                const shuffledSteps = [...allSteps].sort(() => Math.random() - 0.5);
                shuffledSteps.forEach(step => jumbledStepsContainer.appendChild(createStepElement(step.id, step.title)));
            }

            function createTaskElement(taskName) {
                const el = document.createElement('div');
                el.textContent = taskName;
                el.setAttribute('draggable', 'true');
                el.dataset.task = taskName;
                el.className = 'task bg-white p-3 rounded-lg shadow cursor-grab mb-2 border border-gray-200';
                addDragListeners(el);
                return el;
            }

            function createStepElement(stepId, title) {
                const el = document.createElement('div');
                el.dataset.stepId = stepId;
                el.setAttribute('draggable', 'true');
                el.className = 'step-container bg-teal-600 p-4 rounded-xl shadow-lg cursor-grab mb-4 text-left w-full';
                
                const titleEl = document.createElement('h3');
                titleEl.textContent = title;
                titleEl.className = 'text-lg font-bold text-white mb-3 pointer-events-none';
                el.appendChild(titleEl);

                const taskList = document.createElement('div');
                taskList.className = 'task-list min-h-[60px] bg-slate-100 rounded-md p-2 border-2 border-dashed border-slate-300';
                taskList.dataset.dropTarget = 'tasks';
                addDragListeners(taskList); // Listener especÃ­fico para la lista interna
                el.appendChild(taskList);

                addDragListeners(el);
                return el;
            }

            // --- 4. LÃ“GICA DRAG & DROP (MEJORADA) ---

            function addDragListeners(el) {
                el.addEventListener('dragstart', handleDragStart);
                el.addEventListener('dragover', handleDragOver);
                el.addEventListener('dragenter', handleDragEnter);
                el.addEventListener('dragleave', handleDragLeave);
                el.addEventListener('drop', handleDrop);
                el.addEventListener('dragend', handleDragEnd);
            }

            function handleDragStart(e) {
                if (e.target.getAttribute('draggable') !== 'true') return;

                draggedElement = e.target;
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', '');
                
                e.stopPropagation(); 
                setTimeout(() => e.target.classList.add('dragging'), 0);

                // --- Â¡CORRECCIÃ“N CLAVE! ---
                // Deshabilitamos eventos en todos los demÃ¡s elementos del mismo tipo mientras arrastramos.
                // Esto permite soltar "a travÃ©s" de ellos en el contenedor padre.
                if (draggedElement.classList.contains('task')) {
                    document.querySelectorAll('.task').forEach(el => {
                        if (el !== draggedElement) el.style.pointerEvents = 'none';
                    });
                } else if (draggedElement.classList.contains('step-container')) {
                     // Opcional para pasos, pero ayuda si se solapan
                     document.querySelectorAll('.step-container').forEach(el => {
                        if (el !== draggedElement) el.style.pointerEvents = 'none';
                    });
                }
            }

            function handleDragEnd(e) {
                if (draggedElement) {
                    draggedElement.classList.remove('dragging');
                    draggedElement = null;
                }
                // Restauramos pointer-events para que todo vuelva a ser interactivo
                document.querySelectorAll('.task, .step-container').forEach(el => {
                    el.style.pointerEvents = 'auto';
                });
                
                document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
            }

            function handleDragOver(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                return false;
            }

            function handleDragEnter(e) {
                e.preventDefault();
                e.stopPropagation();
                const target = e.currentTarget;
                if (isValidDropTarget(target)) {
                    target.classList.add('drag-over');
                }
            }

            function handleDragLeave(e) {
                e.preventDefault();
                e.stopPropagation();
                e.currentTarget.classList.remove('drag-over');
            }

            function handleDrop(e) {
                e.preventDefault();
                e.stopPropagation();
                
                const target = e.currentTarget;
                target.classList.remove('drag-over');

                if (!draggedElement) return;

                // LÃ³gica para PASOS
                if (draggedElement.classList.contains('step-container')) {
                    if (target.id === 'steps-container') {
                        insertBasedOnMousePosition(target, draggedElement, e.clientY);
                    } else if (target.id === 'jumbled-steps') {
                        target.appendChild(draggedElement);
                    }
                }
                // LÃ³gica para TAREAS
                else if (draggedElement.classList.contains('task')) {
                    if (target.classList.contains('task-list')) {
                        // Soltar en una lista de tareas dentro de un paso
                        target.appendChild(draggedElement);
                    } else if (target.id === 'jumbled-tasks') {
                        // Devolver a la caja de desordenados
                        target.appendChild(draggedElement);
                    }
                }
            }

            // Valida si el target actual acepta el elemento arrastrado
            function isValidDropTarget(target) {
                if (!draggedElement) return false;

                if (draggedElement.classList.contains('step-container')) {
                    return target.id === 'steps-container' || target.id === 'jumbled-steps';
                }
                if (draggedElement.classList.contains('task')) {
                    return target.classList.contains('task-list') || target.id === 'jumbled-tasks';
                }
                return false;
            }

            function insertBasedOnMousePosition(container, element, mouseY) {
                const afterElement = getDragAfterElement(container, mouseY);
                if (afterElement == null) {
                    container.appendChild(element);
                } else {
                    container.insertBefore(element, afterElement);
                }
            }

            function getDragAfterElement(container, y) {
                const draggableElements = [...container.querySelectorAll('[draggable="true"]:not(.dragging)')];

                return draggableElements.reduce((closest, child) => {
                    const box = child.getBoundingClientRect();
                    const offset = y - box.top - box.height / 2;
                    if (offset < 0 && offset > closest.offset) {
                        return { offset: offset, element: child };
                    } else {
                        return closest;
                    }
                }, { offset: Number.NEGATIVE_INFINITY }).element;
            }

            // --- 5. VERIFICACIÃ“N ---

            checkButton.addEventListener('click', () => {
                let allCorrect = true;
                let correctStepsCount = 0;
                let correctTaskGroupsCount = 0;
                const totalSteps = 6;

                const orderedSteps = stepsContainer.querySelectorAll('.step-container');

                // Verificar Pasos
                orderedSteps.forEach((stepElement, index) => {
                    const stepId = stepElement.dataset.stepId;
                    const correctStepId = `step-${index + 1}`;
                    
                    // Verificar Orden
                    if (stepId === correctStepId) {
                        stepElement.classList.remove('ring-4', 'ring-red-400');
                        stepElement.classList.add('ring-4', 'ring-green-400');
                        correctStepsCount++;
                    } else {
                        stepElement.classList.remove('ring-4', 'ring-green-400');
                        stepElement.classList.add('ring-4', 'ring-red-400');
                        allCorrect = false;
                    }

                    // Verificar Tareas
                    const taskList = stepElement.querySelector('.task-list');
                    const tasksInStep = Array.from(taskList.querySelectorAll('.task')).map(t => t.dataset.task);
                    const correctTasks = correctSteps[stepId].tasks;
                    
                    const tasksAreCorrect = tasksInStep.length === correctTasks.length &&
                                            tasksInStep.every(t => correctTasks.includes(t));

                    if (tasksAreCorrect) {
                        taskList.classList.remove('bg-red-100');
                        taskList.classList.add('bg-green-100');
                        correctTaskGroupsCount++;
                    } else {
                        taskList.classList.remove('bg-green-100');
                        taskList.classList.add('bg-red-100');
                        allCorrect = false;
                    }
                });

                // Verificar que no falten piezas
                if (jumbledContainer.children.length > 0 || jumbledStepsContainer.children.length > 0 || orderedSteps.length < totalSteps) {
                    allCorrect = false;
                }

                scoreArea.innerHTML = `
                    <span class="text-indigo-600 block md:inline">Orden de Pasos: ${correctStepsCount} / ${totalSteps}</span>
                    <span class="text-gray-300 mx-2 hidden md:inline">|</span>
                    <span class="text-teal-600 block md:inline">Contenido de Pasos: ${correctTaskGroupsCount} / ${totalSteps}</span>
                `;

                if (allCorrect) {
                    messageArea.textContent = '';
                    successModal.style.display = 'flex';
                    confetti({ particleCount: 150, spread: 90, origin: { y: 0.6 } });
                } else {
                    messageArea.textContent = 'Revisa los bordes rojos. Â¡Algunas piezas no estÃ¡n en su lugar!';
                    messageArea.className = 'mt-6 text-center text-xl font-medium text-red-500';
                }
            });

            resetButton.addEventListener('click', initializeGame);
            closeModalButton.addEventListener('click', () => successModal.style.display = 'none');

            initializeGame();
        });
    </script>
</body>
</html>
