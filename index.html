<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Juego: Ordenar Pasos de Log칤stica</title>
  <!-- Cargamos Tailwind CSS para un dise침o limpio y moderno -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Biblioteca para el efecto de confeti, indicando 칠xito -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.minjs"></script>
  <style>
    /* Estilo para los elementos mientras se arrastran, mejorando la visibilidad */
    .dragging {
      opacity: 0.5;
      transform: scale(0.95);
      box-shadow: 0 10px 20px rgba(0,0,0,0.2);
    }
   먝
    /* Estilo para las zonas de soltar cuando un elemento est치 encima (Feedback visual) */
    .drag-over {
      background-color: #dbeafe; /* bg-blue-100 */
      border-style: dashed;
      border-color: #60a5fa; /* border-blue-400 */
      transform: scale(1.01);
      transition: all 0.2s;
    }
   먝
    /* Animaci칩n suave para la ventana modal */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
   먝
    /* Ocultar la modal por defecto */
    #success-modal {
      display: none;
      z-index: 50;
    }

    /* Asegura que los pasos y tareas puedan reordenarse correctamente */
    .step-container, .task {
      box-sizing: border-box; /* Incluir padding y border en el ancho/alto */
    }
  </style>
</head>
<body class="bg-slate-100 font-sans p-6 md:p-10 min-h-screen">

  <!-- Ventana Modal de 칄xito para feedback inmediato al usuario -->
  <div id="success-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl p-8 text-center max-w-md mx-auto transform transition-all" style="animation: fadeIn 0.3s ease-out;">
      <h2 class="text-4xl font-bold text-green-600 mb-4">춰Excelente!</h2>
      <p class="text-xl text-gray-700 mb-6">춰Has completado el desaf칤o perfectamente! Has demostrado dominio en el proceso log칤stico de importaci칩n. 游꿀</p>
      <button id="close-modal-button" class="px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition-colors focus:outline-none focus:ring-2 focus:ring-indigo-500">
        Cerrar
      </button>
    </div>
  </div>

  <div class="max-w-7xl mx-auto bg-white p-6 md:p-8 rounded-2xl shadow-xl">
    <header class="border-b border-gray-200 pb-6 **mb-4**">
      <h1 class="text-4xl md:text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-teal-500 to-indigo-600 mb-4">
        Desaf칤o: Log칤stica de Importaci칩n
      </h1>
      <p class="text-lg text-gray-600">
        **Instrucci칩n:** Primero, arrastra los **Pasos Principales** (derecha) al 치rea de construcci칩n (izquierda) y ord칠nalos. Luego, arrastra las **Sub-Tareas** dentro del paso que corresponda.
      </p>
     먝
      <!-- 츼rea de Puntuaci칩n para seguimiento en tiempo real -->
      <div id="score-area" class="text-xl font-bold text-gray-700 mt-6 text-center p-4 bg-gray-50 rounded-lg border-l-4 border-indigo-400">
        Presiona "Verificar" para ver tu puntuaci칩n.
      </div>
    </header>

    <!-- Contenedor principal del juego: Grid para layout responsive -->
    <!-- Se invierte el orden de las columnas: Fuente (col-span-1) y Soluci칩n (col-span-2) -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
     먝
      <!-- COLUMNA IZQUIERDA: 츼REA DE CONSTRUCCI칍N DE LA SECUENCIA (Ahora a la izquierda) -->
      <!-- Cambiamos el col-span a 2/3 para que ocupe la mayor parte del espacio a la izquierda -->
      <div class="md:col-span-2 min-h-[400px] bg-blue-50 border-2 border-dashed border-blue-300 rounded-xl p-6 transition-colors duration-200 order-2 md:order-1" id="steps-container" data-type="main-container">
        <!-- Contenedor para la secuencia ordenada de Pasos -->
      </div>

      <!-- COLUMNA DERECHA: FUENTE DE PIEZAS DESORDENADAS (Ahora a la derecha) -->
      <!-- Aseguramos que solo ocupe 1/3 del espacio a la derecha -->
      <div class="md:col-span-1 space-y-6 order-1 md:order-2">
        <!-- Caja de Pasos Desordenados (Elementos principales) -->
        <div class="bg-slate-200 p-4 rounded-lg shadow border-2 border-slate-300">
          <h3 class="text-xl font-semibold text-gray-700 mb-4 text-center">Pasos Principales</h3>
          <div id="jumbled-steps" class="space-y-3 min-h-[100px] transition-colors duration-200 p-2" data-type="steps-source">
            <!-- Pasos desordenados se insertar치n aqu칤 -->
          </div>
        </div>

        <!-- Caja de Tareas Desordenadas (Elementos secundarios) -->
        <div class="bg-slate-200 p-4 rounded-lg shadow border-2 border-slate-300">
          <h3 class="text-xl font-semibold text-gray-700 mb-4 text-center">Sub-Tareas</h3>
          <div id="jumbled-tasks" class="space-y-3 min-h-[200px] transition-colors duration-200 p-2" data-type="tasks-source">
            <!-- Tareas desordenadas se insertar치n aqu칤 -->
          </div>
        </div>
      </div>
    </div>

    <!-- Botones de Acci칩n (Verificar y Reiniciar) -->
    <footer class="mt-10 pt-6 border-t border-gray-200 flex flex-col sm:flex-row justify-center items-center gap-4">
      <button id="check-button" class="w-full sm:w-auto px-8 py-3 bg-teal-600 text-white text-lg font-semibold rounded-lg shadow-md hover:bg-teal-700 transition-all focus:outline-none focus:ring-4 focus:ring-teal-500 focus:ring-opacity-50">
        Verificar Soluci칩n
      </button>
      <button id="reset-button" class="w-full sm:w-auto px-8 py-3 bg-gray-600 text-white text-lg font-semibold rounded-lg shadow-md hover:bg-gray-700 transition-all focus:outline-none focus:ring-4 focus:ring-gray-500 focus:ring-opacity-50">
        Reiniciar
      </button>
    </footer>

    <!-- 츼rea de Mensajes para feedback de errores o estado -->
    <div id="message-area" class="mt-6 text-center text-xl font-medium"></div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {

      // --- 1. DEFINICI칍N DE DATOS (REGLA DE NEGOCIO: SECUENCIA CORRECTA) ---
      // Las claves ('step-1', 'step-2', etc.) definen el orden correcto de los pasos.
      const correctSteps = {
        "step-1": {
          title: "Paso: Contacto proveedor",
          tasks: ["Identificar proveedor", "Negociar y generar acuerdo (Icoterms)"]
        },
        "step-2": {
          title: "Paso: Preparaci칩n y env칤o de mercader칤a",
          tasks: ["Emisi칩n de orden de compra", "Preparaci칩n de mercader칤a", "Documentaci칩n de env칤o"]
        },
        "step-3": {
          title: "Paso: Transporte internacional",
          tasks: ["Transporte de mercader칤a"]
        },
        "step-4": {
          title: "Paso: Proceso Aduanero",
          tasks: ["Arribo y notificaci칩n", "Tr치mite aduanero (DIN)", "Inspecci칩n aduanera"]
        },
        "step-5": {
          title: "Paso: Transporte nacional",
          tasks: ["Liberaci칩n nacional", "Transporte bodega"]
        },
        "step-6": {
          title: "Paso: Recepci칩n y almacenamiento",
          tasks: ["Recepci칩n de mercader칤a", "Almacenamiento de mercader칤a"]
        }
      };

      // Extracci칩n de todas las tareas y pasos para la inicializaci칩n desordenada
      const allTasks = Object.values(correctSteps).flatMap(step => step.tasks);
      const allSteps = Object.keys(correctSteps).map(key => ({ id: key, title: correctSteps[key].title }));

      // --- 2. REFERENCIAS DOM ---
      const jumbledContainer = document.getElementById('jumbled-tasks');
      const jumbledStepsContainer = document.getElementById('jumbled-steps');
      const stepsContainer = document.getElementById('steps-container');
      const checkButton = document.getElementById('check-button');
      const resetButton = document.getElementById('reset-button');
      const messageArea = document.getElementById('message-area');
      const successModal = document.getElementById('success-modal');
      const closeModalButton = document.getElementById('close-modal-button');
      const scoreArea = document.getElementById('score-area');

      let draggedElement = null; // Almacena el elemento que se est치 arrastrando actualmente

      // --- 3. FUNCIONES DE CONSTRUCCI칍N E INICIALIZACI칍N ---
     먝
      // Funci칩n principal para crear un elemento de sub-tarea (Task)
      function createTaskElement(taskName) {
        const el = document.createElement('div');
        el.textContent = taskName;
        el.setAttribute('draggable', 'true');
        el.dataset.task = taskName; // Usamos data-task para la verificaci칩n
        // Estilo para la tarea: Fondo blanco, sombra, borde sutil
        el.className = 'task bg-white p-3 rounded-lg shadow cursor-grab mb-2 border border-gray-200 hover:shadow-lg transition-shadow duration-150';
        addDragListeners(el);
        return el;
      }

      // Funci칩n principal para crear un elemento de paso (Step)
      function createStepElement(stepId, title) {
        const el = document.createElement('div');
        el.dataset.stepId = stepId; // Usamos data-step-id para el orden correcto
        el.setAttribute('draggable', 'true');
        // Estilo para el paso: Color principal, sombra destacada
        el.className = 'step-container bg-teal-600 p-4 rounded-xl shadow-xl cursor-grab mb-4 text-left w-full hover:shadow-2xl transition-shadow duration-150';
       먝
        // T칤tulo del paso
        const titleEl = document.createElement('h3');
        titleEl.textContent = title;
        titleEl.className = 'text-lg font-bold text-white mb-3 pointer-events-none'; // Ignorar drag en el t칤tulo
        el.appendChild(titleEl);

        // Contenedor interno para las sub-tareas (Target de Drop)
        const taskList = document.createElement('div');
        taskList.className = 'task-list min-h-[60px] bg-slate-100 rounded-md p-2 border-2 border-dashed border-slate-300';
        taskList.dataset.dropTarget = 'tasks';
        addDragListeners(taskList); // Listener espec칤fico para la lista interna
        el.appendChild(taskList);

        addDragListeners(el);
        return el;
      }

      // Inicializa el estado del juego: desordena y renderiza los elementos
      function initializeGame() {
        // Limpieza de contenedores
        jumbledContainer.innerHTML = '';
        jumbledStepsContainer.innerHTML = '';
        stepsContainer.innerHTML = '';
        messageArea.innerHTML = '';
        scoreArea.innerHTML = 'Presiona "Verificar" para ver tu puntuaci칩n.';
        successModal.style.display = 'none';

        // Generaci칩n y mezcla de Tareas
        const shuffledTasks = [...allTasks].sort(() => Math.random() - 0.5);
        shuffledTasks.forEach(task => jumbledContainer.appendChild(createTaskElement(task)));

        // Generaci칩n y mezcla de Pasos
        const shuffledSteps = [...allSteps].sort(() => Math.random() - 0.5);
        shuffledSteps.forEach(step => jumbledStepsContainer.appendChild(createStepElement(step.id, step.title)));
      }

      // --- 4. L칍GICA DRAG & DROP ---

      // Asigna todos los listeners de arrastre a un elemento
      function addDragListeners(el) {
        el.addEventListener('dragstart', handleDragStart);
        el.addEventListener('dragover', handleDragOver);
        el.addEventListener('dragenter', handleDragEnter);
        el.addEventListener('dragleave', handleDragLeave);
        el.addEventListener('drop', handleDrop);
        el.addEventListener('dragend', handleDragEnd);
      }

      function handleDragStart(e) {
        if (e.target.getAttribute('draggable') !== 'true') return;

        draggedElement = e.target;
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', '');
       먝
        e.stopPropagation();
        setTimeout(() => e.target.classList.add('dragging'), 0);

        // Deshabilitamos 'pointer-events' en otros elementos arrastrables del mismo tipo
        // para permitir soltar entre ellos (comportamiento de reordenamiento).
        const selector = draggedElement.classList.contains('task') ? '.task' : '.step-container';
        document.querySelectorAll(selector).forEach(el => {
          if (el !== draggedElement) el.style.pointerEvents = 'none';
        });
      }

      function handleDragEnd(e) {
        if (draggedElement) {
          draggedElement.classList.remove('dragging');
          draggedElement = null;
        }
        // Restauramos 'pointer-events' en todos los elementos arrastrables
        document.querySelectorAll('.task, .step-container').forEach(el => {
          el.style.pointerEvents = 'auto';
        });
       먝
        // Limpiamos el feedback visual de drag-over
        document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
      }

      function handleDragOver(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        return false;
      }

      function handleDragEnter(e) {
        e.preventDefault();
        e.stopPropagation();
        const target = e.currentTarget;
        if (isValidDropTarget(target)) {
          target.classList.add('drag-over');
        }
      }

      function handleDragLeave(e) {
        e.preventDefault();
        e.stopPropagation();
        e.currentTarget.classList.remove('drag-over');
      }

      function handleDrop(e) {
        e.preventDefault();
        e.stopPropagation();
       먝
        const target = e.currentTarget;
        target.classList.remove('drag-over');

        if (!draggedElement || !isValidDropTarget(target)) return;

        // L칩gica para arrastrar PASOS
        if (draggedElement.classList.contains('step-container')) {
          if (target.id === 'steps-container') {
            // Reordenar o a침adir al contenedor principal de pasos
            insertBasedOnMousePosition(target, draggedElement, e.clientY);
          } else if (target.id === 'jumbled-steps') {
            // Devolver a la caja de desordenados (Pasos)
            target.appendChild(draggedElement);
          }
        }
        // L칩gica para arrastrar TAREAS
        else if (draggedElement.classList.contains('task')) {
          if (target.classList.contains('task-list')) {
            // Soltar en una lista de tareas dentro de un paso
            target.appendChild(draggedElement);
          } else if (target.id === 'jumbled-tasks') {
            // Devolver a la caja de desordenados (Tareas)
            target.appendChild(draggedElement);
          }
        }
      }

      // Valida si el target actual acepta el elemento arrastrado
      function isValidDropTarget(target) {
        if (!draggedElement) return false;

        // Si arrastro un Paso, solo puedo soltarlo en 'steps-container' o 'jumbled-steps'
        if (draggedElement.classList.contains('step-container')) {
          return target.id === 'steps-container' || target.id === 'jumbled-steps';
        }
        // Si arrastro una Tarea, solo puedo soltarla en un 'task-list' o 'jumbled-tasks'
        if (draggedElement.classList.contains('task')) {
          return target.classList.contains('task-list') || target.id === 'jumbled-tasks';
        }
        return false;
      }

      // L칩gica para reordenar en el contenedor basada en la posici칩n del rat칩n
      function insertBasedOnMousePosition(container, element, mouseY) {
        const afterElement = getDragAfterElement(container, mouseY);
        if (afterElement == null) {
          container.appendChild(element); // Si no hay elemento despu칠s, a침adir al final
        } else {
          container.insertBefore(element, afterElement); // Insertar antes del elemento m치s cercano
        }
      }

      // Busca el elemento m치s cercano para reordenar (Algoritmo de inserci칩n visual)
      function getDragAfterElement(container, y) {
        // Elementos arrastrables que no son el que estamos moviendo
        const draggableElements = [...container.querySelectorAll('[draggable="true"]:not(.dragging)')];

        return draggableElements.reduce((closest, child) => {
          const box = child.getBoundingClientRect();
          // Calcula el desplazamiento desde el centro del elemento hijo
          const offset = y - box.top - box.height / 2;
          // Buscamos el desplazamiento negativo m치s cercano a cero (el que est치 justo despu칠s)
          if (offset < 0 && offset > closest.offset) {
            return { offset: offset, element: child };
          } else {
            return closest;
          }
        }, { offset: Number.NEGATIVE_INFINITY }).element; // Empezamos con un desplazamiento muy peque침o
      }

      // --- 5. L칍GICA DE VERIFICACI칍N (CUELLO DE BOTELLA L칍GICO) ---

      checkButton.addEventListener('click', () => {
        let allCorrect = true;
        let correctStepsCount = 0;
        let correctTaskGroupsCount = 0;
        const totalSteps = Object.keys(correctSteps).length;

        const orderedSteps = stepsContainer.querySelectorAll('.step-container');

        // 5.1. Verificar Orden de Pasos
        orderedSteps.forEach((stepElement, index) => {
          const stepId = stepElement.dataset.stepId; // ID actual (e.g., 'step-4')
          const correctStepId = `step-${index + 1}`; // ID esperado seg칰n la posici칩n (e.g., 'step-1')
         먝
          // L칩gica de Borde: Marcamos el paso principal (verde/rojo)
          if (stepId === correctStepId) {
            stepElement.classList.remove('ring-red-400');
            stepElement.classList.add('ring-4', 'ring-green-400');
            correctStepsCount++;
          } else {
            stepElement.classList.remove('ring-green-400');
            stepElement.classList.add('ring-4', 'ring-red-400');
            allCorrect = false;
          }

          // 5.2. Verificar Contenido de Tareas (dentro del paso)
          const taskList = stepElement.querySelector('.task-list');
          const tasksInStep = Array.from(taskList.querySelectorAll('.task')).map(t => t.dataset.task);
         먝
          // Manejo de errores: Si el paso fue arrastrado al 치rea principal, sus tareas deben ser correctas
          const correctTasks = correctSteps[stepId]?.tasks || [];
         먝
          // Comparamos longitud y si todos los elementos existen en el array correcto (sin importar el orden interno)
          const tasksAreCorrect = tasksInStep.length === correctTasks.length &&
                      tasksInStep.every(t => correctTasks.includes(t));

          // L칩gica de Fondo: Marcamos el contenedor de tareas (verde/rojo)
          taskList.classList.remove('bg-red-100', 'bg-green-100');
          if (tasksAreCorrect) {
            taskList.classList.add('bg-green-100');
            correctTaskGroupsCount++;
          } else {
            taskList.classList.add('bg-red-100');
            allCorrect = false;
          }
        });

        // 5.3. Verificar que no falten piezas en las 치reas de desordenadas
        if (jumbledContainer.children.length > 0 || jumbledStepsContainer.children.length > 0 || orderedSteps.length < totalSteps) {
          allCorrect = false;
        }

        // Actualizar 치rea de puntuaci칩n con m칠tricas claras
        scoreArea.innerHTML = `
          <span class="text-indigo-600 block md:inline">Orden de Pasos: ${correctStepsCount} / ${totalSteps}</span>
          <span class="text-gray-300 mx-4 hidden md:inline">|</span>
          <span class="text-teal-600 block md:inline">Contenido de Pasos: ${correctTaskGroupsCount} / ${totalSteps}</span>
        `;

        // Feedback final
        if (allCorrect) {
          messageArea.textContent = '춰Todo correcto! Eres un experto en log칤stica.';
          messageArea.className = 'mt-6 text-center text-xl font-medium text-green-600';
          successModal.style.display = 'flex';
          // Efecto de celebraci칩n
          confetti({ particleCount: 150, spread: 90, origin: { y: 0.6 } });
        } else {
          messageArea.textContent = 'Revisa los bordes rojos. 춰A칰n faltan piezas o el orden es incorrecto!';
          messageArea.className = 'mt-6 text-center text-xl font-medium text-red-500';
        }
      });

      // --- 6. LISTENERS GLOBALES ---
      resetButton.addEventListener('click', initializeGame);
      closeModalButton.addEventListener('click', () => successModal.style.display = 'none');

      // Inicializar el juego al cargar la p치gina
      initializeGame();
    });
  </script>
</body>
</html>
