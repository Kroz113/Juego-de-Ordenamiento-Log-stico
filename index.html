<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Juego: Ordenar Pasos de Log칤stica</title>
    <!-- Cargamos Tailwind CSS para un dise침o limpio -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configuraci칩n para usar la fuente Inter -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <!-- Biblioteca para el efecto de confeti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        /* Estilo para los elementos mientras se arrastran */
        .dragging {
            opacity: 0.5;
            transform: scale(0.95);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            transition: all 0.2s;
        }
        
        /* Estilo para las zonas de soltar cuando un elemento est치 encima */
        .drag-over {
            background-color: #dbeafe; /* bg-blue-100 */
            border-style: solid;
            border-width: 4px;
            border-color: #60a5fa; /* border-blue-400 */
            transform: scale(1.005);
            transition: all 0.2s;
        }

        /* Aseguramos que los pasos en el contenedor principal tengan un peque침o margen entre ellos */
        #steps-container > .step-container {
            margin-bottom: 1rem;
        }
        
        /* Animaci칩n suave para los elementos al aparecer */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Estilos para la ventana modal de 칠xito */
        #success-modal {
            display: none;
            z-index: 50;
            backdrop-filter: blur(5px);
        }
    </style>
</head>
<body class="bg-slate-50 font-sans p-4 md:p-10">

    <!-- Ventana Modal de 칄xito -->
    <div id="success-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl p-8 text-center max-w-md mx-auto transform transition-all" style="animation: fadeIn 0.3s ease-out;">
            <h2 class="text-4xl font-extrabold text-green-600 mb-4 tracking-tight">춰칄xito en la Cadena de Suministro!</h2>
            <p class="text-xl text-gray-700 mb-6">춰Has completado el desaf칤o de log칤stica de importaci칩n perfectamente! Todos los pasos y sub-tareas est치n en orden. 游꿀</p>
            <button id="close-modal-button" class="px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition-colors focus:outline-none focus:ring-4 focus:ring-indigo-300">
                Cerrar
            </button>
        </div>
    </div>

    <div class="max-w-7xl mx-auto bg-white p-6 md:p-10 rounded-2xl shadow-2xl border border-gray-100">
        <header class="border-b border-gray-200 pb-6 mb-8">
            <h1 class="text-4xl md:text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-teal-500 to-indigo-700 mb-3 leading-tight">
                Desaf칤o: Log칤stica de Importaci칩n
            </h1>
            <p class="text-lg text-gray-600">
                Arrastra y ordena los **Pasos Principales** en la columna izquierda, asegur치ndote de que sigan la secuencia l칩gica. Luego, arrastra las **Sub-Tareas** (derecha) dentro del paso que corresponda.
            </p>
            
            <!-- 츼rea de Puntuaci칩n -->
            <div id="score-area" class="text-xl font-bold text-gray-700 mt-6 text-center p-4 bg-gray-50 rounded-lg border border-gray-200 shadow-inner">
                Presiona "Verificar" para ver tu puntuaci칩n.
            </div>
        </header>

        <!-- Contenedor principal del juego -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- COLUMNA IZQUIERDA: 츼REA DE CONSTRUCCI칍N -->
            <div class="lg:col-span-2 min-h-[500px] bg-blue-50 border-4 border-dashed border-blue-300 rounded-xl p-4 sm:p-6 transition-colors duration-300" id="steps-container" data-type="main-container">
                <p class="text-gray-500 italic text-center p-4" id="placeholder-text">Arrastra los pasos principales aqu칤.</p>
                <!-- Los pasos ordenados ir치n aqu칤 -->
            </div>

            <!-- COLUMNA DERECHA: PIEZAS -->
            <div class="lg:col-span-1 space-y-6">
                <!-- Caja de Pasos Desordenados -->
                <div class="bg-slate-100 p-4 rounded-xl shadow-lg border border-slate-200">
                    <h3 class="text-xl font-bold text-slate-700 mb-4 text-center border-b pb-2">Pasos Principales</h3>
                    <div id="jumbled-steps" class="space-y-3 min-h-[100px] transition-colors duration-200 p-2" data-type="steps-source">
                        <!-- Pasos desordenados ir치n aqu칤 -->
                    </div>
                </div>

                <!-- Caja de Tareas Desordenadas -->
                <div class="bg-slate-100 p-4 rounded-xl shadow-lg border border-slate-200">
                    <h3 class="text-xl font-bold text-slate-700 mb-4 text-center border-b pb-2">Sub-Tareas</h3>
                    <div id="jumbled-tasks" class="space-y-3 min-h-[200px] transition-colors duration-200 p-2" data-type="tasks-source">
                        <!-- Tareas desordenadas ir치n aqu칤 -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Botones de Acci칩n -->
        <footer class="mt-10 pt-6 border-t border-gray-200 flex flex-col sm:flex-row justify-center items-center gap-4">
            <button id="check-button" class="w-full sm:w-auto px-10 py-3 bg-teal-600 text-white text-lg font-bold rounded-lg shadow-xl hover:bg-teal-700 transition-all transform hover:scale-[1.02] focus:outline-none focus:ring-4 focus:ring-teal-300">
                Verificar Soluci칩n
            </button>
            <button id="reset-button" class="w-full sm:w-auto px-10 py-3 bg-gray-600 text-white text-lg font-bold rounded-lg shadow-xl hover:bg-gray-700 transition-all transform hover:scale-[1.02] focus:outline-none focus:ring-4 focus:ring-gray-300">
                Reiniciar Juego
            </button>
        </footer>

        <!-- 츼rea de Mensajes -->
        <div id="message-area" class="mt-6 text-center text-xl font-medium"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- 1. DEFINICI칍N DE DATOS ---
            // La clave de cada paso debe ser 'step-N' donde N es la posici칩n correcta (1-6)
            const correctSteps = {
                "step-1": {
                    title: "Contacto con el proveedor y acuerdo inicial",
                    tasks: ["Identificar proveedor", "Negociar y generar acuerdo (Icoterms)"]
                },
                "step-2": {
                    title: "Preparaci칩n de la mercader칤a y documentaci칩n de origen",
                    tasks: ["Emisi칩n de orden de compra", "Preparaci칩n de mercader칤a", "Documentaci칩n de env칤o"]
                },
                "step-3": {
                    title: "Contrataci칩n y ejecuci칩n del Transporte internacional",
                    tasks: ["Transporte de mercader칤a", "Contrataci칩n de Agente de Carga"]
                },
                "step-4": {
                    title: "Proceso Aduanero en el pa칤s de destino",
                    tasks: ["Arribo y notificaci칩n", "Tr치mite aduanero (DIN)", "Inspecci칩n aduanera", "Pago de aranceles"]
                },
                "step-5": {
                    title: "Transporte nacional y distribuci칩n final",
                    tasks: ["Liberaci칩n nacional", "Transporte a bodega o cliente final"]
                },
                "step-6": {
                    title: "Recepci칩n, control de calidad y almacenamiento",
                    tasks: ["Recepci칩n de mercader칤a", "Control de calidad de la importaci칩n", "Almacenamiento de mercader칤a"]
                }
            };

            // Recolectar todas las tareas y pasos para la inicializaci칩n
            const allTasks = Object.values(correctSteps).flatMap(step => step.tasks);
            const allSteps = Object.keys(correctSteps).map(key => ({ id: key, title: correctSteps[key].title }));

            // --- 2. REFERENCIAS DOM ---
            const jumbledContainer = document.getElementById('jumbled-tasks');
            const jumbledStepsContainer = document.getElementById('jumbled-steps');
            const stepsContainer = document.getElementById('steps-container');
            const checkButton = document.getElementById('check-button');
            const resetButton = document.getElementById('reset-button');
            const messageArea = document.getElementById('message-area');
            const successModal = document.getElementById('success-modal');
            const closeModalButton = document.getElementById('close-modal-button');
            const scoreArea = document.getElementById('score-area');
            const placeholderText = document.getElementById('placeholder-text');

            let draggedElement = null;

            // --- 3. INICIALIZACI칍N Y CREACI칍N DE ELEMENTOS ---

            // Funci칩n para mezclar un array (Algoritmo de Fisher-Yates)
            function shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
            }

            function initializeGame() {
                jumbledContainer.innerHTML = '';
                jumbledStepsContainer.innerHTML = '';
                stepsContainer.innerHTML = '';
                messageArea.innerHTML = '';
                scoreArea.innerHTML = 'Presiona "Verificar Soluci칩n" para ver tu puntuaci칩n.';
                successModal.style.display = 'none';
                placeholderText.style.display = 'block';

                // Re-inicializar listeners para los contenedores principales
                [stepsContainer, jumbledContainer, jumbledStepsContainer].forEach(container => {
                    addDragListeners(container);
                    container.classList.remove('ring-4', 'ring-red-400', 'ring-green-400'); // Limpiar estilos
                });

                // Mezclar y crear sub-tareas
                const shuffledTasks = [...allTasks];
                shuffleArray(shuffledTasks);
                shuffledTasks.forEach(task => jumbledContainer.appendChild(createTaskElement(task)));

                // Mezclar y crear pasos principales
                const shuffledSteps = [...allSteps];
                shuffleArray(shuffledSteps);
                shuffledSteps.forEach(step => jumbledStepsContainer.appendChild(createStepElement(step.id, step.title)));

                // Limpiar posibles rings de verificaci칩n
                document.querySelectorAll('.step-container, .task-list').forEach(el => {
                    el.classList.remove('ring-4', 'ring-red-400', 'ring-green-400', 'bg-red-100', 'bg-green-100');
                });
            }

            function createTaskElement(taskName) {
                const el = document.createElement('div');
                el.textContent = taskName;
                el.setAttribute('draggable', 'true');
                el.dataset.task = taskName;
                el.className = 'task bg-white p-3 rounded-lg shadow-md cursor-grab border border-gray-300 hover:bg-gray-50 transition-colors transform hover:scale-[1.01]';
                addDragListeners(el);
                return el;
            }

            function createStepElement(stepId, title) {
                const el = document.createElement('div');
                el.dataset.stepId = stepId;
                el.setAttribute('draggable', 'true');
                el.className = 'step-container bg-indigo-600 p-4 rounded-xl shadow-lg cursor-grab text-left w-full transition-shadow duration-200';
                
                const titleEl = document.createElement('h3');
                titleEl.textContent = title;
                titleEl.className = 'text-xl font-bold text-white mb-3 pointer-events-none border-b border-indigo-400 pb-2';
                el.appendChild(titleEl);

                const taskList = document.createElement('div');
                taskList.innerHTML = '<p class="text-sm text-gray-400 text-center py-2">Arrastra sub-tareas aqu칤</p>';
                taskList.className = 'task-list min-h-[60px] bg-slate-100 rounded-lg p-3 border-4 border-dashed border-slate-300 space-y-2';
                taskList.dataset.dropTarget = 'tasks';
                addDragListeners(taskList); // Listener espec칤fico para la lista interna
                el.appendChild(taskList);

                addDragListeners(el);
                return el;
            }

            // --- 4. L칍GICA DRAG & DROP ---

            function addDragListeners(el) {
                el.addEventListener('dragstart', handleDragStart);
                el.addEventListener('dragover', handleDragOver);
                el.addEventListener('dragenter', handleDragEnter);
                el.addEventListener('dragleave', handleDragLeave);
                el.addEventListener('drop', handleDrop);
                el.addEventListener('dragend', handleDragEnd);
            }

            function handleDragStart(e) {
                if (e.target.getAttribute('draggable') !== 'true') return;

                draggedElement = e.target;
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', draggedElement.dataset.task || draggedElement.dataset.stepId);
                
                // Ocultar el elemento arrastrado temporalmente para evitar que se interfiera con los drops
                setTimeout(() => {
                    if (draggedElement) draggedElement.classList.add('dragging');
                }, 0);

                // Deshabilitar pointer-events para permitir soltar entre elementos del mismo tipo
                document.querySelectorAll('.task, .step-container').forEach(el => {
                    if (el !== draggedElement) el.style.pointerEvents = 'none';
                });
            }

            function handleDragEnd(e) {
                if (draggedElement) {
                    draggedElement.classList.remove('dragging');
                    draggedElement = null;
                }
                // Restaurar pointer-events
                document.querySelectorAll('.task, .step-container').forEach(el => {
                    el.style.pointerEvents = 'auto';
                });
                
                document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));

                // Ocultar placeholder si hay pasos
                placeholderText.style.display = stepsContainer.children.length === 0 ? 'block' : 'none';
            }

            function handleDragOver(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
            }

            function handleDragEnter(e) {
                e.preventDefault();
                const target = e.currentTarget;
                if (isValidDropTarget(target)) {
                    target.classList.add('drag-over');
                }
            }

            function handleDragLeave(e) {
                e.preventDefault();
                e.currentTarget.classList.remove('drag-over');
            }

            function handleDrop(e) {
                e.preventDefault();
                const target = e.currentTarget;
                target.classList.remove('drag-over');

                if (!draggedElement || !isValidDropTarget(target)) return;

                // L칩gica para Pasos Principales
                if (draggedElement.classList.contains('step-container')) {
                    if (target.id === 'steps-container') {
                        // Soltar en el contenedor principal para ordenar
                        insertBasedOnMousePosition(target, draggedElement, e.clientY);
                    } else if (target.id === 'jumbled-steps') {
                        // Devolver a la caja de desordenados de pasos
                        target.appendChild(draggedElement);
                    }
                }
                // L칩gica para Sub-Tareas
                else if (draggedElement.classList.contains('task')) {
                    if (target.classList.contains('task-list')) {
                        // Soltar en una lista de tareas (dentro de un paso)
                        // Asegurar que el mensaje de placeholder de la lista interna se elimine
                        const placeholder = target.querySelector('p');
                        if (placeholder && placeholder.textContent === 'Arrastra sub-tareas aqu칤') {
                            placeholder.remove();
                        }
                        target.appendChild(draggedElement);
                    } else if (target.id === 'jumbled-tasks') {
                        // Devolver a la caja de desordenados de tareas
                        target.appendChild(draggedElement);
                    }
                }

                // Asegurar que el elemento arrastrado ya no tenga la clase 'dragging'
                draggedElement.classList.remove('dragging');
                draggedElement = null;
            }

            // Valida si el target actual acepta el elemento arrastrado
            function isValidDropTarget(target) {
                if (!draggedElement) return false;

                if (draggedElement.classList.contains('step-container')) {
                    return target.id === 'steps-container' || target.id === 'jumbled-steps';
                }
                if (draggedElement.classList.contains('task')) {
                    return target.classList.contains('task-list') || target.id === 'jumbled-tasks';
                }
                return false;
            }

            // Determina d칩nde insertar un elemento en un contenedor ordenable
            function insertBasedOnMousePosition(container, element, mouseY) {
                const draggableElements = [...container.querySelectorAll('.step-container:not(.dragging)')];

                const closest = draggableElements.reduce((closest, child) => {
                    const box = child.getBoundingClientRect();
                    const offset = mouseY - box.top - box.height / 2;
                    // Buscamos el elemento que est치 justo debajo del mouse (offset < 0) y es el m치s cercano al 0 (closest.offset)
                    if (offset < 0 && offset > closest.offset) {
                        return { offset: offset, element: child };
                    } else {
                        return closest;
                    }
                }, { offset: Number.NEGATIVE_INFINITY, element: null });
                
                if (closest.element == null) {
                    container.appendChild(element);
                } else {
                    container.insertBefore(element, closest.element);
                }
            }


            // --- 5. VERIFICACI칍N Y PUNTUACI칍N ---

            checkButton.addEventListener('click', () => {
                let allCorrect = true;
                let correctStepsCount = 0;
                let correctTaskGroupsCount = 0;
                const totalSteps = Object.keys(correctSteps).length;
                let totalCorrectTasks = 0;
                let totalPlacedTasks = 0;
                const totalPossibleTasks = allTasks.length;

                const orderedSteps = stepsContainer.querySelectorAll('.step-container');

                if (orderedSteps.length !== totalSteps) {
                    messageArea.textContent = 'Aseg칰rate de arrastrar todos los 6 Pasos Principales.';
                    messageArea.className = 'mt-6 text-center text-xl font-medium text-orange-600';
                    allCorrect = false;
                    scoreArea.innerHTML = `Orden de Pasos: 0 / ${totalSteps} | Contenido de Pasos: 0 / ${totalSteps}`;
                    return;
                }

                // 1. Verificar Orden de Pasos
                orderedSteps.forEach((stepElement, index) => {
                    const stepId = stepElement.dataset.stepId;
                    const correctStepId = `step-${index + 1}`;
                    
                    // Limpiar estilos previos
                    stepElement.classList.remove('ring-4', 'ring-red-400', 'ring-green-400', 'ring-indigo-400');
                    stepElement.querySelector('.task-list').classList.remove('bg-red-100', 'bg-green-100', 'ring-4', 'ring-red-400');

                    if (stepId === correctStepId) {
                        stepElement.classList.add('ring-4', 'ring-green-400');
                        correctStepsCount++;
                    } else {
                        stepElement.classList.add('ring-4', 'ring-red-400');
                        allCorrect = false;
                    }

                    // 2. Verificar Tareas por Paso (Categorizaci칩n)
                    const taskList = stepElement.querySelector('.task-list');
                    const tasksInStep = Array.from(taskList.querySelectorAll('.task')).map(t => t.dataset.task);
                    const correctTasks = correctSteps[stepId].tasks;
                    totalPlacedTasks += tasksInStep.length;

                    // Comprobar si todas las tareas en este paso son correctas Y no falta ninguna
                    const tasksAreCorrect = tasksInStep.every(t => correctTasks.includes(t)) &&
                                            tasksInStep.length === correctTasks.length;

                    if (tasksAreCorrect) {
                        taskList.classList.add('bg-green-100');
                        correctTaskGroupsCount++;
                        totalCorrectTasks += tasksInStep.length;
                    } else {
                        taskList.classList.add('bg-red-100', 'ring-4', 'ring-red-400');
                        allCorrect = false;
                        // Contar tareas correctas individuales dentro de un grupo incorrecto para la puntuaci칩n
                        tasksInStep.forEach(t => {
                            if (correctTasks.includes(t)) {
                                totalCorrectTasks++;
                            }
                        });
                    }

                    // Marcar tareas individuales para feedback visual
                    Array.from(taskList.querySelectorAll('.task')).forEach(taskEl => {
                        const taskName = taskEl.dataset.task;
                        taskEl.classList.remove('border-green-500', 'border-red-500', 'border-4');
                        if (correctTasks.includes(taskName)) {
                            taskEl.classList.add('border-4', 'border-green-500');
                        } else {
                            taskEl.classList.add('border-4', 'border-red-500');
                            allCorrect = false;
                        }
                    });
                });

                // 3. Verificar si quedan piezas en los contenedores de origen
                if (jumbledContainer.children.length > 0 || jumbledStepsContainer.children.length > 0) {
                    allCorrect = false;
                    messageArea.textContent = '춰A칰n te quedan piezas por colocar!';
                    messageArea.className = 'mt-6 text-center text-xl font-medium text-red-500';
                }

                // Actualizar 치rea de puntuaci칩n
                scoreArea.innerHTML = `
                    <span class="text-indigo-600 block md:inline">Orden de Pasos Correcto: <span class="text-2xl">${correctStepsCount} / ${totalSteps}</span></span>
                    <span class="text-gray-300 mx-4 hidden md:inline">|</span>
                    <span class="text-teal-600 block md:inline">Tareas en Paso Correcto: <span class="text-2xl">${correctTaskGroupsCount} / ${totalSteps}</span></span>
                    <span class="text-gray-300 mx-4 hidden md:inline">|</span>
                    <span class="text-blue-600 block md:inline">Total Sub-Tareas Correctas: <span class="text-2xl">${totalCorrectTasks} / ${totalPossibleTasks}</span></span>
                `;

                if (allCorrect) {
                    messageArea.textContent = '춰Todo en orden! La cadena de suministro est치 optimizada.';
                    messageArea.className = 'mt-6 text-center text-xl font-bold text-green-600';
                    successModal.style.display = 'flex';
                    // Confeti con m치s estilo
                    confetti({ 
                        particleCount: 200, 
                        spread: 120, 
                        origin: { y: 0.6 },
                        colors: ['#10b981', '#4f46e5', '#f59e0b']
                    });
                } else if (jumbledContainer.children.length === 0 && jumbledStepsContainer.children.length === 0 && orderedSteps.length === totalSteps) {
                    messageArea.textContent = 'Revisa los bordes rojos. 춰Est치s cerca, pero la secuencia o la categorizaci칩n necesitan ajustes!';
                    messageArea.className = 'mt-6 text-center text-xl font-medium text-red-500';
                }
            });

            resetButton.addEventListener('click', initializeGame);
            closeModalButton.addEventListener('click', () => successModal.style.display = 'none');

            // Iniciar el juego
            initializeGame();
        });
    </script>
</body>
</html>
